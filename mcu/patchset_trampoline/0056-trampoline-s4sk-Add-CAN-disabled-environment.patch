From 0856fbc621c01324f151963d293549d360c7ae0d Mon Sep 17 00:00:00 2001
From: Tsutomu Muroya <tsutomu.muroya.jy@bp.renesas.com>
Date: Thu, 9 Nov 2023 20:32:04 +0900
Subject: [PATCH] trampoline: s4sk: Add CAN disabled environment

Signed-off-by: Tsutomu Muroya <tsutomu.muroya.jy@bp.renesas.com>
---
 examples/renesas/sample/build_not_can.sh   | 17 +++++
 examples/renesas/sample/sample.c           |  2 +-
 examples/renesas/sample/sample_not_can.c   | 15 +++++
 examples/renesas/sample/sample_not_can.oil | 77 ++++++++++++++++++++++
 4 files changed, 110 insertions(+), 1 deletion(-)
 create mode 100755 examples/renesas/sample/build_not_can.sh
 create mode 100644 examples/renesas/sample/sample_not_can.c
 create mode 100644 examples/renesas/sample/sample_not_can.oil

diff --git a/examples/renesas/sample/build_not_can.sh b/examples/renesas/sample/build_not_can.sh
new file mode 100755
index 00000000..758c8d3d
--- /dev/null
+++ b/examples/renesas/sample/build_not_can.sh
@@ -0,0 +1,17 @@
+#!/usr/bin/env bash
+
+#stop on errors
+set -e
+
+if [[ ! -d "_build" ]]
+then
+    mkdir _build
+fi
+
+echo "*** Run Goil ***"
+goil --target=renesas/g4mh --templates=../../../goil/templates/ sample_not_can.oil
+cd _build
+echo "*** Run CMake ***"
+cmake -G "Unix Makefiles" -D CMAKE_TOOLCHAIN_FILE=../sample/compiler.cmake ..
+echo "*** Run Make ***"
+make
diff --git a/examples/renesas/sample/sample.c b/examples/renesas/sample/sample.c
index 9d6bbf96..b1782112 100644
--- a/examples/renesas/sample/sample.c
+++ b/examples/renesas/sample/sample.c
@@ -7,10 +7,10 @@ extern int can_demo_init(void);
 
 FUNC(int, OS_APPL_CODE) main(void)
 {
-	Serial_Init();
 	iccom_init();
 	can_demo_init();
 	memory_unlocker();
+	Serial_Init();
 	StartOS(OSDEFAULTAPPMODE);
 	return 0;
 }
diff --git a/examples/renesas/sample/sample_not_can.c b/examples/renesas/sample/sample_not_can.c
new file mode 100644
index 00000000..a9bd0136
--- /dev/null
+++ b/examples/renesas/sample/sample_not_can.c
@@ -0,0 +1,15 @@
+#include "tpl_os.h"
+#include "serial.h"
+
+extern void memory_unlocker(void);
+extern void iccom_init(void);
+
+FUNC(int, OS_APPL_CODE) main(void)
+{
+	iccom_init();
+	memory_unlocker();
+	Serial_Init();
+	StartOS(OSDEFAULTAPPMODE);
+	return 0;
+}
+
diff --git a/examples/renesas/sample/sample_not_can.oil b/examples/renesas/sample/sample_not_can.oil
new file mode 100644
index 00000000..f4d2728f
--- /dev/null
+++ b/examples/renesas/sample/sample_not_can.oil
@@ -0,0 +1,77 @@
+OIL_VERSION = "4.2";
+
+IMPLEMENTATION trampoline {
+  TASK {
+    UINT32 STACKSIZE = 2048 ;
+  } ;
+
+  ISR {
+    UINT32 STACKSIZE = 2048 ;
+  } ;
+};
+
+CPU iccom {
+  OS config {
+    STATUS = EXTENDED;
+    PAINT_STACK = TRUE;
+    PAINT_REGISTERS = TRUE;
+    
+    BUILD = TRUE {
+      TRAMPOLINE_BASE_PATH = "../../../";
+      APP_NAME = "sample_exe";
+      APP_SRC = "sample_not_can.c";
+      APP_SRC = "memory_unlocker.c";
+      APP_SRC = "iccom.c";
+      APP_SRC = "iccom_ll.c"; 
+      APP_SRC = "benchmark.c";
+      APP_SRC = "dhrystone/dhry_1.c";
+      APP_SRC = "dhrystone/dhry_2.c";
+      APP_SRC = "coremark/barebones/core_portme.c";
+      APP_SRC = "coremark/core_list_join.c";
+      APP_SRC = "coremark/core_main.c";
+      APP_SRC = "coremark/core_matrix.c";
+      APP_SRC = "coremark/core_state.c";
+      APP_SRC = "coremark/core_util.c";
+      LDFLAGS="-debug -nocompress -NOOPtimize -memory=high -nologo -SHow=ALL";
+      CFLAGS="-Xcpu=g4mh -g -g_line -Xfxu=off -Xasm_path=.";
+      CFLAGS="-Xfloat=soft -Xdbl_size=8 -Xround=nearest";
+      CFLAGS="-DTIME=TIME";
+      CFLAGS="-Ospeed -Oinline_size";
+      CFLAGS="-I../coremark -I../coremark/barebones -DITERATIONS=30000";
+      CFLAGS="-DHSCIF_921600BPS";
+      LINKER = "rlink";
+      SYSTEM = CMAKE;
+      LIBRARY = serial;
+    };
+    SYSTEM_CALL = TRUE;
+  };
+
+  APPMODE std {};
+
+  TASK iccom {
+    PRIORITY = 1;
+    AUTOSTART = FALSE;
+    ACTIVATION = 1;
+    SCHEDULE = FULL;
+  };
+
+  ISR iccomIntClear {
+    CATEGORY = 1;
+    PRIORITY = 1;
+    SOURCE = iccomInt;
+  };
+  
+  ISR iccomInt {
+    CATEGORY = 2; //FSY unsupported
+    PRIORITY = 1;
+    SOURCE = iccomInt; //SysTick;
+  };
+
+  COUNTER SystemCounter {
+    SOURCE = SysTick;
+    MAXALLOWEDVALUE = 10000;
+    TICKSPERBASE = 1;
+    MINCYCLE = 1;
+  };
+
+};
-- 
2.25.1

