From 38c201533ade38de695137453714382829e276da Mon Sep 17 00:00:00 2001
From: Florian Sylvestre <fsylvestre@baylibre.com>
Date: Mon, 23 Oct 2023 14:59:32 +0200
Subject: [PATCH 02/38] spider: Add Serial example for g4mh

---
 examples/renesas/serial/build.sh   | 17 +++++++++
 examples/renesas/serial/serial.c   | 39 ++++++++++++++++++++
 examples/renesas/serial/serial.oil | 59 ++++++++++++++++++++++++++++++
 3 files changed, 115 insertions(+)
 create mode 100644 examples/renesas/serial/build.sh
 create mode 100755 examples/renesas/serial/serial.c
 create mode 100755 examples/renesas/serial/serial.oil

diff --git a/examples/renesas/serial/build.sh b/examples/renesas/serial/build.sh
new file mode 100644
index 00000000..443cf9b8
--- /dev/null
+++ b/examples/renesas/serial/build.sh
@@ -0,0 +1,17 @@
+#!/usr/bin/env bash
+
+#stop on errors
+set -e
+
+if [[ ! -d "_build" ]]
+then
+    mkdir _build
+fi
+
+echo "*** Run Goil ***"
+goil --target=renesas/g4mh --templates=../../../goil/templates/ serial.oil
+cd _build
+echo "*** Run CMake ***"
+cmake -G "Unix Makefiles" -D CMAKE_TOOLCHAIN_FILE=../serial/compiler.cmake ..
+echo "*** Run Make ***"
+make
diff --git a/examples/renesas/serial/serial.c b/examples/renesas/serial/serial.c
new file mode 100755
index 00000000..cb868eb1
--- /dev/null
+++ b/examples/renesas/serial/serial.c
@@ -0,0 +1,39 @@
+#include "tpl_os.h"
+
+#include "serial.h"
+#include "printf.h"
+
+FUNC(int, OS_APPL_CODE) main(void)
+{
+
+	StartOS(OSDEFAULTAPPMODE);
+	return 0;
+}
+
+volatile uint32 tmp = 0;
+
+TASK(serial_rx)
+{
+	uint8 uart_rx;
+
+	Serial_Init();
+
+	debug_printf("serial_rx task started\r\n");
+
+	while(1)
+	{
+		if (Serial_Rx(&uart_rx))
+		{
+			/* If received a char, send back the next one */
+			Serial_Tx(uart_rx+1);
+		}
+	}
+}
+
+TASK(serial_tx)
+{
+	/* Send next alphabet letter each time*/
+	static uint8 uart_char=0;
+	uart_char = (uart_char+1) % 26;
+	Serial_Tx('a' + uart_char);
+}
diff --git a/examples/renesas/serial/serial.oil b/examples/renesas/serial/serial.oil
new file mode 100755
index 00000000..79b227cf
--- /dev/null
+++ b/examples/renesas/serial/serial.oil
@@ -0,0 +1,59 @@
+OIL_VERSION = "4.2";
+
+IMPLEMENTATION trampoline {
+  TASK {
+    UINT32 STACKSIZE = 2048 ;
+  } ;
+
+  ISR {
+    UINT32 STACKSIZE = 2048 ;
+  } ;
+};
+
+CPU serial {
+  OS config {
+    STATUS = EXTENDED;
+
+    BUILD = TRUE {
+      TRAMPOLINE_BASE_PATH = "../../../";
+      APP_SRC = "serial.c";
+      APP_NAME = "serial_exe";
+      LDFLAGS="-debug -nocompress -NOOPtimize -memory=high -nologo -SHow=ALL";
+      CFLAGS="-DHSCIF_1843200BPS -Xcpu=g4mh -g -g_line -Xfxu=off -Xasm_path=.";
+      LINKER = "rlink";
+      SYSTEM = CMAKE;
+
+      LIBRARY = serial;
+    };
+    SYSTEM_CALL = TRUE;
+  };
+
+  APPMODE std {};
+
+  TASK serial_rx { 
+    PRIORITY = 1;
+    AUTOSTART = TRUE { APPMODE = std; };
+    ACTIVATION = 1;
+    SCHEDULE = FULL;
+  };
+
+  TASK serial_tx {
+    PRIORITY = 2;
+    AUTOSTART = FALSE;
+    ACTIVATION = 1;
+    SCHEDULE = FULL;
+  };
+
+  ALARM serial_serial {
+    COUNTER = SystemCounter;
+    ACTION = ACTIVATETASK {
+      TASK = serial_tx;
+    };
+    AUTOSTART = TRUE {
+      APPMODE = std;
+      ALARMTIME = 100;
+      CYCLETIME = 100;
+    };
+  };
+};
+
-- 
2.34.1

