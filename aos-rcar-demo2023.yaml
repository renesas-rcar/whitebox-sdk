desc: "Aos virtual development machine"
min_ver: "0.11"

variables:
  # Common build configuration

  YOCTOS_WORK_DIR: "yocto"
  GENERIC_MACHINE: "generic-armv8-xt"

  # Aos unit configuration

  UNIT_MODEL: "rcar-demo2023"
  UNIT_VERSION: "1.0"

  # Aos FOTA configuration

  BUNDLE_IMAGE_VERSION: "0.2.0"
  BUNDLE_REF_VERSION: "0.1.0"
  BUNDLE_DOM0_TYPE: "full"
  BUNDLE_DOMD_TYPE: "full"
  BUNDLE_RH850_TYPE: ""
  RH850_IMAGE_VERSION: "1.0.0"
  RH850_IMAGE_PATH: "${TOPDIR}/../../../../sample_image_RH850/v1.0/OTA_AlcoholApp_Image"

  # Aos node configuration

  GEN4_DOMD_NODE_ID: "gen4-domd"
  GEN4_DOM0_NODE_ID: "gen4-dom0"

  GEN3_DOMD_NODE_ID: "gen3-domd"
  GEN3_DOM0_NODE_ID: "gen3-dom0"

  NODE_LIST: "%{GEN4_DOMD_NODE_ID}"
  UM_LIST: "%{GEN4_DOMD_NODE_ID}"

  # Network configuration

  GEN4_DOMAIN_NAME: "gen4"
  GEN4_DOM0_HOST_NAME: "dom0"
  GEN4_DOMD_HOST_NAME: "domd"
  GEN4_DHCP_NET: "10.0.1"
  GEN4_DOM0_IP: "10.0.1.2"

  GEN3_DOMAIN_NAME: "gen3"
  GEN3_DOM0_HOST_NAME: "dom0"
  GEN3_DOMD_HOST_NAME: "domd"
  GEN3_DHCP_NET: "10.0.2"
  GEN3_DOM0_IP: "10.0.2.2"

  NODE_ADDRESSES: "%{GEN4_DOMD_HOST_NAME}.%{GEN4_DOMAIN_NAME} %{GEN4_DOM0_HOST_NAME}.%{GEN4_DOMAIN_NAME}"

  # Gen4 build configuration

  GEN4_MACHINE: "spider"
  GEN4_SOC_FAMILY: "r8a779f0"

  GEN4_DOM0_BUILD_DIR: "build/gen4/dom0"
  GEN4_DOMD_BUILD_DIR: "build/gen4/domd"

  GEN4_XT_DOMD_DTB_NAME: "%{GEN4_SOC_FAMILY}-%{GEN4_MACHINE}-domd.dtb"
  GEN4_XT_XEN_DTB_NAME: "%{GEN4_SOC_FAMILY}-%{GEN4_MACHINE}-xen.dtb"
  GEN4_XT_DOMD_CONFIG_NAME: "domd-%{GEN4_MACHINE}.cfg"

  GEN4_XT_OPTEE_FLAVOR: "%{GEN4_MACHINE}_s4"

  GEN4_XT_KERNEL_BRANCH: "v5.10.41/rcar-5.1.7.rc5-xt"
  GEN4_XT_KERNEL_REV: "${AUTOREV}"

  GEN4_XT_DOMD_IMAGE: "rcar-image-minimal"
  USE_UFS: "0"

  # Gen3 build configuration

  GEN3_DOM0_BUILD_DIR: "build/gen3/dom0"
  GEN3_DOMD_BUILD_DIR: "build/gen3/domd"

  GEN3_XT_DOMD_DTB_NAME: "%{GEN3_SOC_FAMILY}-%{GEN3_MACHINE}-domd.dtb"
  GEN3_XT_XEN_DTB_NAME: "%{GEN3_SOC_FAMILY}-%{GEN3_MACHINE}-xen.dtb"

  GEN3_XT_DOMD_IMAGE: "core-image-weston"
  XT_USE_DDK1_11: "0"
  XT_PREBUILT_GSX_DIR: ""
  XT_MULTIMEDIA_EVA_DIR: ""

common_data:
  # Sources used by all domains
  common_sources: &COMMON_SOURCES
    - type: git
      url: "https://git.yoctoproject.org/poky"
      rev: "3155eb565f"
    - type: git
      url: "https://git.openembedded.org/meta-openembedded"
      rev: "7203130ed"
    - type: git
      url: "https://git.yoctoproject.org/meta-virtualization"
      rev: "beea119"
    - type: git
      url: "git://git.yoctoproject.org/meta-security"
      rev: "c62970f"
    - type: git
      url: "https://github.com/aoscloud/meta-aos"
      rev: "v7.0.1"
    - type: git
      url: "https://github.com/xen-troops/meta-xt-common.git"
      rev: "c1ad85f"
    - type: git
      url: "https://github.com/aoscloud/meta-aos-rcar-demo2023"
      rev: "v0.2.0"

  # Sources to be used in DomD
  domd_sources: &DOMD_SOURCES
    - type: git
      url: "git://git.yoctoproject.org/meta-selinux"
      rev: "1a13839"

  # Sources to be used in Gen3 only
  gen3_sources: &GEN3_SOURCES
    - type: git
      url: "https://github.com/xen-troops/meta-xt-rcar.git"
      rev: "5d4e9d1"

  # Common configuration options for all yocto-based domains
  common_conf: &COMMON_CONF
    - [SSTATE_DIR, "${TOPDIR}/../../../../../common_data/sstate"]
    - [DL_DIR, "${TOPDIR}/../../../../../common_data/downloads"]

    # Skip warning about missing "virtualization" distro feature
    - [SKIP_META_VIRT_SANITY_CHECK, "1"]

    # Use hypervisor console on all guests
    - [SERIAL_CONSOLES, "115200;hvc0"]

    # Init manager
    - [INIT_MANAGER, "systemd"]

    # Do not install kernel image to rootfs to decrease initrd size
    - ["RDEPENDS_${KERNEL_PACKAGE_NAME}-base", ""]

    # Remove features that we are not using
    - [
        DISTRO_FEATURES_remove,
        "x11 gtk gobject-introspection-data wifi nfc
        bluetooth irda zeroconf 3g sysvinit acl argp pcmcia usbgadget
        usbhost ptest multiarch vulkan sysvinit",
      ]

    # Aos configuration
    - [UNIT_MODEL, "%{UNIT_MODEL}"]
    - [UNIT_VERSION, "%{UNIT_VERSION}"]
    - [MAIN_NODE_ADDRESS, "%{GEN4_DOMD_HOST_NAME}.%{GEN4_DOMAIN_NAME}"]
    - [DOM0_IMAGE_VERSION, "%{BUNDLE_IMAGE_VERSION}"]
    - [DOMD_IMAGE_VERSION, "%{BUNDLE_IMAGE_VERSION}"]

  # Common configuration options for all dom0
  dom0_conf: &DOM0_CONF

    # Disable HWDB which quite huge (around 15MB) and is not required at all
    - [BAD_RECOMMENDATIONS_append, " udev-hwdb"]

    - [AOS_RUNNER, "runx"]

    # Aos configuration
    - [BUNDLE_DIR, "${TOPDIR}/../../../.."]
    - [BUNDLE_OSTREE_REPO, "${TOPDIR}/../../../../rootfs_repo"]
    - [BUNDLE_IMAGE_VERSION, "%{BUNDLE_IMAGE_VERSION}"]
    - [BUNDLE_DOM0_TYPE, "%{BUNDLE_DOM0_TYPE}"]
    - [BUNDLE_DOMD_TYPE, "%{BUNDLE_DOMD_TYPE}"]
    - [DOMD_REF_VERSION, "%{BUNDLE_REF_VERSION}"]

  # Common configuration options for all domx
  domx_conf: &DOMX_CONF

    # add the static lib to SDK toolchain
    - [SDKIMAGE_FEATURES_append, " staticdev-pkgs"]

    # Remove ptest to reduce the build time
    - [DISTRO_FEATURES_remove, "ptest"]

    # Add Capacity Aware migration Strategy (CAS)
    - [MACHINE_FEATURES_append, " cas"]

    # Enable seccomp for crun
    - [DISTRO_FEATURES_append, " seccomp"]

    # Initramfs configuration
    - [INITRAMFS_IMAGE, "aos-image-initramfs"]
    - [INITRAMFS_IMAGE_BUNDLE, "0"]
    - [INITRAMFS_FSTYPES, "cpio.gz"]

    # Generate ext4 image files
    - [IMAGE_FSTYPES_append, " ext4"]

components:
  gen4-dom0:
    build-dir: "%{YOCTOS_WORK_DIR}"
    default: true
    sources:
      - *COMMON_SOURCES

    builder:
      type: yocto
      work_dir: "%{GEN4_DOM0_BUILD_DIR}"
      conf:
        - *COMMON_CONF
        - *DOM0_CONF
        - [MACHINE, "%{GENERIC_MACHINE}"]
        - [XT_DOM_NAME, "dom0"]
        - [XT_DOMD_CONFIG_NAME, "%{GEN4_XT_DOMD_CONFIG_NAME}"]
        - [XT_DOMD_DTB_NAME, "%{GEN4_XT_DOMD_DTB_NAME}"]
        - [XT_GUEST_INSTALL, "domd"]
        - [XT_XEN_DTB_NAME, "%{GEN4_XT_XEN_DTB_NAME}"]
        - [XT_DOMD_MACHINE, "%{GEN4_MACHINE}"]
        - [XT_DOMD_IMAGE, "%{GEN4_XT_DOMD_IMAGE}"]

        # Network configuration
        - [DOMAIN_NAME, "%{GEN4_DOMAIN_NAME}"]
        - [HOST_NAME, "%{GEN4_DOM0_HOST_NAME}"]
        - [DOM0_MAC, "08:00:27:ff:cf:cb"]

        # Aos configuration
        - [NODE_ID, "%{GEN4_DOM0_NODE_ID}"]
        - [NODE_TYPE, "%{UNIT_MODEL}-%{UNIT_VERSION}-${NODE_ID}"]
        - [RH850_IMAGE_VERSION, "%{RH850_IMAGE_VERSION}"]
        - [BUNDLE_RH850_TYPE, "%{BUNDLE_RH850_TYPE}"]
        - [RH850_IMAGE_PATH, "%{RH850_IMAGE_PATH}"]

      layers:
        - "../../../meta-virtualization"
        - "../../../meta-openembedded/meta-oe"
        - "../../../meta-openembedded/meta-filesystems"
        - "../../../meta-openembedded/meta-python"
        - "../../../meta-openembedded/meta-networking"
        - "../../../meta-aos"
        - "../../../meta-xt-common/meta-xt-control-domain"
        - "../../../meta-xt-common/meta-xt-domx"
        - "../../../meta-xt-common/meta-xt-dom0"
        - "../../../../../meta-aos-rcar-common/meta-aos-rcar-common-domx"
        - "../../../../../meta-aos-rcar-common/meta-aos-rcar-common-dom0"
        - "../../../../../meta-aos-rcar-gen4/meta-aos-rcar-gen4-domx"
        - "../../../../../meta-aos-rcar-gen4/meta-aos-rcar-gen4-dom0"
        - "../../../../../meta-aos-rcar-gen4/meta-aos-rcar-gen4-control-domain"

      build_target: core-image-thin-initramfs
      external_src:
        domd: "%{YOCTOS_WORK_DIR}/%{GEN4_DOMD_BUILD_DIR}/tmp/deploy/images/%{GEN4_MACHINE}/"

      additional_deps:
        - "%{GEN4_DOMD_BUILD_DIR}/tmp/deploy/images/%{GEN4_MACHINE}/Image"

      target_images:
        - "tmp/deploy/images/%{GENERIC_MACHINE}/Image"
        - "tmp/deploy/images/%{GENERIC_MACHINE}/uInitramfs"
        - "tmp/deploy/images/%{GENERIC_MACHINE}/aos/version"
        - "tmp/deploy/images/%{GENERIC_MACHINE}/aos/.unprovisioned"

  gen4-domd:
    build-dir: "%{YOCTOS_WORK_DIR}"
    sources:
      - *COMMON_SOURCES
      - *DOMD_SOURCES

    builder:
      type: yocto
      work_dir: "%{GEN4_DOMD_BUILD_DIR}"
      conf:
        - *COMMON_CONF
        - *DOMX_CONF
        - [MACHINE, "%{GEN4_MACHINE}"]
        - [SOC_FAMILY, "%{GEN4_SOC_FAMILY}"]
        - [XT_DOM_NAME, "domd"]
        - [XT_DEVICE_TREES, "%{GEN4_XT_DOMD_DTB_NAME} %{GEN4_XT_XEN_DTB_NAME}"]
        - [XT_KERNEL_BRANCH, "%{GEN4_XT_KERNEL_BRANCH}"]
        - [XT_KERNEL_REV, "%{GEN4_XT_KERNEL_REV}"]
        - [XT_OP_TEE_FLAVOUR, "%{GEN4_XT_OPTEE_FLAVOR}"]

        # Network configuration
        - [DOMAIN_NAME, "%{GEN4_DOMAIN_NAME}"]
        - [HOST_NAME, "%{GEN4_DOMD_HOST_NAME}"]
        - [DOM0_HOST_NAME, "%{GEN4_DOM0_HOST_NAME}"]
        - [DHCP_NET, "%{GEN4_DHCP_NET}"]
        - [DOM0_IP, "%{GEN4_DOM0_IP}"]
        - [GEN3_DHCP_NET, "%{GEN3_DHCP_NET}"]
        - [DNSMASQ_INTERFACES, "tsn1"]
        - [DNSMASQ_SERVERS, "/%{GEN3_DOMAIN_NAME}/10.0.0.2"]
        - [DNSMASQ_ADDRESSES, "/wwwivi/%{GEN4_DHCP_NET}.1"]

        # Aos configuration
        - [NODE_ID, "%{GEN4_DOMD_NODE_ID}"]
        - [NODE_TYPE, "%{UNIT_MODEL}-%{UNIT_VERSION}-${NODE_ID}"]
        - [NODE_LIST, "%{NODE_LIST}"]
        - [UM_LIST, "%{UM_LIST}"]
        - [NODE_ADDRESSES, "%{NODE_ADDRESSES}"]

        - [VIS_DATA_PROVIDER, "%{AOS_VIS_DATA_PROVIDER}"]
        - [USE_UFS, "%{USE_UFS}"]

      build_target: "%{GEN4_XT_DOMD_IMAGE}"
      layers:
        - "../../../poky/meta"
        - "../../../poky/meta-poky"
        - "../../../poky/meta-yocto-bsp"
        - "../../../meta-virtualization"
        - "../../../meta-openembedded/meta-oe"
        - "../../../meta-openembedded/meta-networking"
        - "../../../meta-openembedded/meta-perl"
        - "../../../meta-openembedded/meta-python"
        - "../../../meta-openembedded/meta-filesystems"
        - "../../../meta-selinux"
        - "../../../meta-security"
        - "../../../meta-aos"
        - "../../../meta-renesas-gen4/meta-rcar-gateway"
        - "../../../meta-xt-common/meta-xt-domx"
        - "../../../meta-xt-common/meta-xt-driver-domain"
        - "../../../../../meta-aos-rcar-common/meta-aos-rcar-common-domx"
        - "../../../../../meta-aos-rcar-common/meta-aos-rcar-common-domd"
        - "../../../../../meta-aos-rcar-gen4/meta-aos-rcar-gen4-domx"
        - "../../../../../meta-aos-rcar-gen4/meta-aos-rcar-gen4-domd"
        - "../../../../../meta-aos-rcar-gen4/meta-aos-rcar-gen4-driver-domain"

      target_images:
        - "tmp/deploy/images/%{GEN4_MACHINE}/Image"
        - "tmp/deploy/images/%{GEN4_MACHINE}/xen-%{GEN4_MACHINE}.uImage"
        - "tmp/deploy/images/%{GEN4_MACHINE}/xenpolicy-%{GEN4_MACHINE}"
        - "tmp/deploy/images/%{GEN4_MACHINE}/%{GEN4_XT_XEN_DTB_NAME}"
        - "tmp/deploy/images/%{GEN4_MACHINE}/rcar-image-minimal-%{GEN4_MACHINE}.ext4"
        - "tmp/deploy/images/%{GEN4_MACHINE}/aos/.unprovisioned"

  gen3-dom0:
    build-dir: "%{YOCTOS_WORK_DIR}"
    sources:
      - *COMMON_SOURCES
      - *GEN3_SOURCES
    builder:
      type: yocto
      work_dir: "%{GEN3_DOM0_BUILD_DIR}"
      conf:
        - *COMMON_CONF
        - *DOM0_CONF
        - [MACHINE, "%{GENERIC_MACHINE}"]
        - [XT_DOM_NAME, "dom0"]
        - [XT_DOMD_CONFIG_NAME, "%{GEN3_XT_DOMD_CONFIG_NAME}"]
        - [XT_DOMD_DTB_NAME, "%{GEN3_XT_DOMD_DTB_NAME}"]
        - [XT_GUEST_INSTALL, "domd"]
        - [XT_XEN_DTB_NAME, "%{GEN3_XT_XEN_DTB_NAME}"]
        - [XT_DOMD_MACHINE, "%{GEN3_MACHINE}"]
        - [XT_DOMD_IMAGE, "%{GEN3_XT_DOMD_IMAGE}"]

        # Network configuration
        - [DOMAIN_NAME, "%{GEN3_DOMAIN_NAME}"]
        - [HOST_NAME, "%{GEN3_DOM0_HOST_NAME}"]
        - [DOM0_MAC, "08:00:27:ff:cb:cb"]

        # Aos configuration
        - [NODE_ID, "%{GEN3_DOM0_NODE_ID}"]
        - [NODE_TYPE, "%{UNIT_MODEL}-%{UNIT_VERSION}-${NODE_ID}"]

      layers:
        - "../../../meta-virtualization"
        - "../../../meta-openembedded/meta-oe"
        - "../../../meta-openembedded/meta-filesystems"
        - "../../../meta-openembedded/meta-python"
        - "../../../meta-openembedded/meta-networking"
        - "../../../meta-aos"
        - "../../../meta-xt-common/meta-xt-control-domain"
        - "../../../meta-xt-common/meta-xt-domx"
        - "../../../meta-xt-common/meta-xt-dom0"
        - "../../../meta-xt-rcar/meta-xt-rcar-dom0"
        - "../../../../../meta-aos-rcar-common/meta-aos-rcar-common-domx"
        - "../../../../../meta-aos-rcar-common/meta-aos-rcar-common-dom0"
        - "../../../../../meta-aos-rcar-gen3/meta-aos-rcar-gen3-dom0"

      build_target: core-image-thin-initramfs
      external_src:
        domd: "%{YOCTOS_WORK_DIR}/%{GEN3_DOMD_BUILD_DIR}/tmp/deploy/images/%{GEN3_MACHINE}/"
      additional_deps:
        - "%{GEN3_DOMD_BUILD_DIR}/tmp/deploy/images/%{GEN3_MACHINE}/Image"
      target_images:
        - "tmp/deploy/images/%{GENERIC_MACHINE}/Image"
        - "tmp/deploy/images/%{GENERIC_MACHINE}/uInitramfs"
        - "tmp/deploy/images/%{GENERIC_MACHINE}/aos/version"
        - "tmp/deploy/images/%{GENERIC_MACHINE}/aos/.unprovisioned"

  gen3-domd:
    build-dir: "%{YOCTOS_WORK_DIR}"
    sources:
      - *COMMON_SOURCES
      - *DOMD_SOURCES
      - *GEN3_SOURCES
      - type: git
        url: https://github.com/xen-troops/meta-renesas.git
        # rev: "Renesas-Yocto-v5.1-patched"
        rev: "Renesas-Yocto-v5.9-patched"
        #url: https://github.com/renesas-rcar/meta-renesas.git
        #rev: "c5b39adbabdb8fd51517cf37190552b8fb57d062"
        dir: "meta-renesas-gen3"
    builder:
      type: yocto
      work_dir: "%{GEN3_DOMD_BUILD_DIR}"
      conf:
        - *COMMON_CONF
        - *DOMX_CONF
        - [MACHINE, "%{GEN3_MACHINE}"]
        - [SOC_FAMILY, "%{GEN3_SOC_FAMILY}"]
        - [XT_DOM_NAME, "domd"]
        - [XT_DEVICE_TREES, "%{GEN3_XT_DOMD_DTB_NAME} %{GEN3_XT_XEN_DTB_NAME}"]
        - [XT_OP_TEE_FLAVOUR, "%{GEN3_XT_OP_TEE_FLAVOUR}"]

        # Network configuration
        - [DOMAIN_NAME, "%{GEN3_DOMAIN_NAME}"]
        - [HOST_NAME, "%{GEN3_DOMD_HOST_NAME}"]
        - [DOM0_HOST_NAME, "%{GEN3_DOM0_HOST_NAME}"]
        - [DHCP_NET, "%{GEN3_DHCP_NET}"]
        - [DOM0_IP, "%{GEN3_DOM0_IP}"]
        - [DNSMASQ_INTERFACES, "eth0"]
        - [DNSMASQ_ADDRESSES, "/wwwivi/%{GEN4_DHCP_NET}.1"]
        - [DNSMASQ_ADDRESSES, "/gen4/%{GEN4_DHCP_NET}.1"]

        # Aos configuration
        - [NODE_ID, "%{GEN3_DOMD_NODE_ID}"]
        - [NODE_TYPE, "%{UNIT_MODEL}-%{UNIT_VERSION}-${NODE_ID}"]

      build_target: "%{GEN3_XT_DOMD_IMAGE}"
      layers:
        - "../../../poky/meta"
        - "../../../poky/meta-poky"
        - "../../../poky/meta-yocto-bsp"
        - "../../../meta-virtualization"
        - "../../../meta-openembedded/meta-oe"
        - "../../../meta-openembedded/meta-networking"
        - "../../../meta-openembedded/meta-perl"
        - "../../../meta-openembedded/meta-python"
        - "../../../meta-openembedded/meta-filesystems"
        - "../../../meta-selinux"
        - "../../../meta-security"
        - "../../../meta-aos"
        - "../../../meta-renesas-gen3/meta-rcar-gen3"
        - "../../../meta-xt-common/meta-xt-domx"
        - "../../../meta-xt-common/meta-xt-driver-domain"
        - "../../../meta-xt-rcar/meta-oe-fixups"
        - "../../../meta-xt-rcar/meta-xt-rcar-fixups"
        - "../../../meta-xt-rcar/meta-xt-rcar-domx"
        - "../../../meta-xt-rcar/meta-xt-rcar-driver-domain"
        - "../../../../../meta-aos-rcar-common/meta-aos-rcar-common-domx"
        - "../../../../../meta-aos-rcar-common/meta-aos-rcar-common-domd"
        - "../../../../../meta-aos-rcar-gen3/meta-aos-rcar-gen3-domd"

      target_images:
        - "tmp/deploy/images/%{GEN3_MACHINE}/Image"
        - "tmp/deploy/images/%{GEN3_MACHINE}/xen-%{GEN3_MACHINE}.uImage"
        - "tmp/deploy/images/%{GEN3_MACHINE}/xenpolicy-%{GEN3_MACHINE}"
        - "tmp/deploy/images/%{GEN3_MACHINE}/%{GEN3_XT_XEN_DTB_NAME}"
        - "tmp/deploy/images/%{GEN3_MACHINE}/core-image-weston-%{GEN3_MACHINE}.ext4"
        - "tmp/deploy/images/%{GEN3_MACHINE}/aos/.unprovisioned"

  gen3-domd-fota:
    build-dir: "%{YOCTOS_WORK_DIR}"
    sources:
      - *COMMON_SOURCES
      - *GEN3_SOURCES
    builder:
      type: yocto
      work_dir: "%{GEN3_DOM0_BUILD_DIR}-update"
      conf:
        - *COMMON_CONF
        - *DOM0_CONF
        - [MACHINE, "%{GENERIC_MACHINE}"]
        - [XT_DOM_NAME, "dom0"]
        - [XT_DOMD_CONFIG_NAME, "%{GEN3_XT_DOMD_CONFIG_NAME}"]
        - [XT_DOMD_DTB_NAME, "%{GEN3_XT_DOMD_DTB_NAME}"]
        - [XT_GUEST_INSTALL, "domd"]
        - [XT_XEN_DTB_NAME, "%{GEN3_XT_XEN_DTB_NAME}"]
        - [XT_DOMD_MACHINE, "%{GEN3_MACHINE}"]
        - [XT_DOMD_IMAGE, "%{GEN3_XT_DOMD_IMAGE}"]

        # Network configuration
        - [DOMAIN_NAME, "%{GEN3_DOMAIN_NAME}"]
        - [HOST_NAME, "%{GEN3_DOM0_HOST_NAME}"]
        - [DOM0_MAC, "08:00:27:ff:cb:cb"]

        # Aos configuration
        - [NODE_ID, "%{GEN3_DOM0_NODE_ID}"]
        - [NODE_TYPE, "%{UNIT_MODEL}-%{UNIT_VERSION}-${NODE_ID}"]

        # Enable only DomD
        - [BUNDLE_DOM0_TYPE, ""]
        - [BUNDLE_DOMD_TYPE, "full"]
        # For incremental fota(Currently, doesn't work well)
        # - [BUNDLE_DOMD_TYPE, "incremental"]
        # - [AOS_DOMD_REF_VERSION, "%{BUNDLE_REF_VERSION}"]
        # - [BUNDLE_RH840_TYPE, "%{BUNDLE_RH850_TYPE}"]

      layers:
        - "../../../meta-virtualization"
        - "../../../meta-openembedded/meta-oe"
        - "../../../meta-openembedded/meta-filesystems"
        - "../../../meta-openembedded/meta-python"
        - "../../../meta-openembedded/meta-networking"
        - "../../../meta-aos"
        - "../../../meta-xt-common/meta-xt-control-domain"
        - "../../../meta-xt-common/meta-xt-domx"
        - "../../../meta-xt-common/meta-xt-dom0"
        - "../../../meta-xt-rcar/meta-xt-rcar-dom0"
        - "../../../../../meta-aos-rcar-common/meta-aos-rcar-common-domx"
        - "../../../../../meta-aos-rcar-common/meta-aos-rcar-common-dom0"
        - "../../../../../meta-aos-rcar-gen3/meta-aos-rcar-gen3-dom0"

      build_target: aos-update
      external_src:
        domd: "%{YOCTOS_WORK_DIR}/%{GEN3_DOMD_BUILD_DIR}/tmp/deploy/images/%{GEN3_MACHINE}/"
      additional_deps:
        - "%{GEN3_DOMD_BUILD_DIR}/tmp/deploy/images/%{GEN3_MACHINE}/Image"
      target_images:
        - "tmp/deploy/images/%{GENERIC_MACHINE}/Image"

  gen3-domd-fota-inc:
    build-dir: "%{YOCTOS_WORK_DIR}"
    sources:
      - *COMMON_SOURCES
      - *GEN3_SOURCES
    builder:
      type: yocto
      work_dir: "%{GEN3_DOM0_BUILD_DIR}-update-inc"
      conf:
        - *COMMON_CONF
        - *DOM0_CONF
        - [MACHINE, "%{GENERIC_MACHINE}"]
        - [XT_DOM_NAME, "dom0"]
        - [XT_DOMD_CONFIG_NAME, "%{GEN3_XT_DOMD_CONFIG_NAME}"]
        - [XT_DOMD_DTB_NAME, "%{GEN3_XT_DOMD_DTB_NAME}"]
        - [XT_GUEST_INSTALL, "domd"]
        - [XT_XEN_DTB_NAME, "%{GEN3_XT_XEN_DTB_NAME}"]
        - [XT_DOMD_MACHINE, "%{GEN3_MACHINE}"]
        - [XT_DOMD_IMAGE, "%{GEN3_XT_DOMD_IMAGE}"]

        # Network configuration
        - [DOMAIN_NAME, "%{GEN3_DOMAIN_NAME}"]
        - [HOST_NAME, "%{GEN3_DOM0_HOST_NAME}"]
        - [DOM0_MAC, "08:00:27:ff:cb:cb"]

        # Aos configuration
        - [NODE_ID, "%{GEN3_DOM0_NODE_ID}"]
        - [NODE_TYPE, "%{UNIT_MODEL}-%{UNIT_VERSION}-${NODE_ID}"]

        # Enable only DomD
        - [BUNDLE_DOM0_TYPE, ""]
        - [BUNDLE_DOMD_TYPE, "full"]
        # For incremental fota(Currently, doesn't work well)
        - [BUNDLE_DOMD_TYPE, "incremental"]
        - [AOS_DOMD_REF_VERSION, "%{BUNDLE_REF_VERSION}"]
        - [BUNDLE_RH840_TYPE, "%{BUNDLE_RH850_TYPE}"]

      layers:
        - "../../../meta-virtualization"
        - "../../../meta-openembedded/meta-oe"
        - "../../../meta-openembedded/meta-filesystems"
        - "../../../meta-openembedded/meta-python"
        - "../../../meta-openembedded/meta-networking"
        - "../../../meta-aos"
        - "../../../meta-xt-common/meta-xt-control-domain"
        - "../../../meta-xt-common/meta-xt-domx"
        - "../../../meta-xt-common/meta-xt-dom0"
        - "../../../meta-xt-rcar/meta-xt-rcar-dom0"
        - "../../../../../meta-aos-rcar-common/meta-aos-rcar-common-domx"
        - "../../../../../meta-aos-rcar-common/meta-aos-rcar-common-dom0"
        - "../../../../../meta-aos-rcar-gen3/meta-aos-rcar-gen3-dom0"

      build_target: aos-update
      external_src:
        domd: "%{YOCTOS_WORK_DIR}/%{GEN3_DOMD_BUILD_DIR}/tmp/deploy/images/%{GEN3_MACHINE}/"
      additional_deps:
        - "%{GEN3_DOMD_BUILD_DIR}/tmp/deploy/images/%{GEN3_MACHINE}/Image"
      target_images:
        - "tmp/deploy/images/%{GENERIC_MACHINE}/Image"

  fota:
    builder:
      type: custom_script
      work_dir: "fota"
      script: "../scripts/fota_builder.py"
      args: "-v"
      target_images:
        - "output/fota/%{UNIT_MODEL}-%{UNIT_VERSION}-%{BUNDLE_IMAGE_VERSION}.tar"

      additional_deps:
        - "%{YOCTOS_WORK_DIR}/%{GEN3_DOMD_BUILD_DIR}/tmp/deploy/images/%{GEN3_MACHINE}/xen-%{GEN3_MACHINE}.uImage"
        - "%{YOCTOS_WORK_DIR}/%{GEN3_DOMD_BUILD_DIR}/tmp/deploy/images/%{GEN3_MACHINE}/xenpolicy-%{GEN3_MACHINE}"
        - "%{YOCTOS_WORK_DIR}/%{GEN3_DOMD_BUILD_DIR}/tmp/deploy/images/%{GEN3_MACHINE}/%{GEN3_XT_XEN_DTB_NAME}"
        - "%{YOCTOS_WORK_DIR}/%{GEN3_DOMD_BUILD_DIR}/tmp/deploy/images/%{GEN3_MACHINE}/Image-%{GEN3_MACHINE}.bin"
        - "%{YOCTOS_WORK_DIR}/%{GEN3_DOMD_BUILD_DIR}/tmp/deploy/images/%{GEN3_MACHINE}/aos-image-initramfs-%{GEN3_MACHINE}.cpio.gz"
          #- "%{YOCTOS_WORK_DIR}/%{GEN3_DOMD_BUILD_DIR}/tmp/deploy/images/%{GEN3_MACHINE}/aos/boot/version"

      components:
        rootfs-full:
          componentType: "%{UNIT_MODEL}-%{UNIT_VERSION}-%{GEN3_DOMD_NODE_ID}"
          enabled: true
          method: "overlay"
          yocto_dir: "%{YOCTOS_WORK_DIR}"
          build_dir: "%{GEN3_DOMD_BUILD_DIR}"
          type: "full"
          description: "gen3-domd rootfs image"
          vendorVersion: "%{BUNDLE_IMAGE_VERSION}"
          exclude:
          exclude:
            - "var/*"
          fileName: "%{UNIT_MODEL}-%{UNIT_VERSION}-rootfs-full-%{BUNDLE_IMAGE_VERSION}.squashfs"


images:
  gen4_full:
    type: gpt
    desc: "Full SD-card/eMMC image"
    partitions:
      boot_a:
        gpt_type: 21686148-6449-6E6F-744E-656564454649 # BIOS boot partition (kinda...)
        type: ext4
        size: 128 MiB
        files:
          "/aos/version": "%{YOCTOS_WORK_DIR}/%{GEN4_DOM0_BUILD_DIR}/tmp/deploy/images/%{GENERIC_MACHINE}/aos/version"
          "Image": "%{YOCTOS_WORK_DIR}/%{GEN4_DOM0_BUILD_DIR}/tmp/deploy/images/%{GENERIC_MACHINE}/Image"
          "uInitramfs": "%{YOCTOS_WORK_DIR}/%{GEN4_DOM0_BUILD_DIR}/tmp/deploy/images/%{GENERIC_MACHINE}/uInitramfs"
          "xen": "%{YOCTOS_WORK_DIR}/%{GEN4_DOMD_BUILD_DIR}/tmp/deploy/images/%{GEN4_MACHINE}/xen-%{GEN4_MACHINE}.uImage"
          "xenpolicy": "%{YOCTOS_WORK_DIR}/%{GEN4_DOMD_BUILD_DIR}/tmp/deploy/images/%{GEN4_MACHINE}/xenpolicy-%{GEN4_MACHINE}"
          "xen.dtb": "%{YOCTOS_WORK_DIR}/%{GEN4_DOMD_BUILD_DIR}/tmp/deploy/images/%{GEN4_MACHINE}/%{GEN4_XT_XEN_DTB_NAME}"

      boot_b:
        gpt_type: 21686148-6449-6E6F-744E-656564454649 # BIOS boot partition (kinda...)
        type: ext4
        size: 128 MiB
        files:
          "/aos/version": "%{YOCTOS_WORK_DIR}/%{GEN4_DOM0_BUILD_DIR}/tmp/deploy/images/%{GENERIC_MACHINE}/aos/version"
          "Image": "%{YOCTOS_WORK_DIR}/%{GEN4_DOM0_BUILD_DIR}/tmp/deploy/images/%{GENERIC_MACHINE}/Image"
          "uInitramfs": "%{YOCTOS_WORK_DIR}/%{GEN4_DOM0_BUILD_DIR}/tmp/deploy/images/%{GENERIC_MACHINE}/uInitramfs"
          "xen": "%{YOCTOS_WORK_DIR}/%{GEN4_DOMD_BUILD_DIR}/tmp/deploy/images/%{GEN4_MACHINE}/xen-%{GEN4_MACHINE}.uImage"
          "xenpolicy": "%{YOCTOS_WORK_DIR}/%{GEN4_DOMD_BUILD_DIR}/tmp/deploy/images/%{GEN4_MACHINE}/xenpolicy-%{GEN4_MACHINE}"
          "xen.dtb": "%{YOCTOS_WORK_DIR}/%{GEN4_DOMD_BUILD_DIR}/tmp/deploy/images/%{GEN4_MACHINE}/%{GEN4_XT_XEN_DTB_NAME}"

      boot_env:
        gpt_type: 21686148-6449-6E6F-744E-656564454649 # BIOS boot partition (kinda...)
        type: vfat
        size: 16 MiB

      domd_rootfs:
        gpt_type: B921B045-1DF0-41C3-AF44-4C6F280D3FAE # Linux aarch64 root
        type: raw_image
        size: 2048 MiB
        image_path: "%{YOCTOS_WORK_DIR}/%{GEN4_DOMD_BUILD_DIR}/tmp/deploy/images/%{GEN4_MACHINE}/rcar-image-minimal-%{GEN4_MACHINE}.ext4"

      domd_var:
        gpt_type: B921B045-1DF0-41C3-AF44-4C6F280D3FAE # Linux aarch64 root
        type: ext4
        size: 512 MiB
        files:
          "/aos/.unprovisioned": "%{YOCTOS_WORK_DIR}/%{GEN4_DOMD_BUILD_DIR}/tmp/deploy/images/%{GEN4_MACHINE}/aos/.unprovisioned"
          "/boot-mmc.uImage": "%{YOCTOS_WORK_DIR}/%{GEN4_DOMD_BUILD_DIR}/tmp/deploy/images/%{GEN4_MACHINE}/boot-mmc.uImage"

      domd_aos:
        gpt_type: CA7D7CCB-63ED-4C53-861C-1742536059CC # LUKS partition
        type: empty
        size: 1024 MiB

      dom0_aos:
        gpt_type: B921B045-1DF0-41C3-AF44-4C6F280D3FAE # Linux aarch64 root
        type: ext4
        size: 512 MiB
        files:
          "/.unprovisioned": "%{YOCTOS_WORK_DIR}/%{GEN4_DOM0_BUILD_DIR}/tmp/deploy/images/%{GENERIC_MACHINE}/aos/.unprovisioned"

parameters:
  GEN3_DEVICE:
    desc: "Add RCAR Gen3-based device as Aos nodes"
    enable:
      default: true
      overrides:
        variables:
          # NODE_LIST: "%{GEN4_DOMD_NODE_ID} %{GEN4_DOM0_NODE_ID} %{GEN3_DOMD_NODE_ID} %{GEN3_DOM0_NODE_ID}"
          # UM_LIST: "%{GEN4_DOMD_NODE_ID} %{GEN3_DOMD_NODE_ID}"
          # NODE_ADDRESSES: "%{GEN4_DOMD_HOST_NAME}.%{GEN4_DOMAIN_NAME} %{GEN4_DOM0_HOST_NAME}.%{GEN4_DOMAIN_NAME} %{GEN3_DOMD_HOST_NAME}.%{GEN3_DOMAIN_NAME} %{GEN3_DOM0_HOST_NAME}.%{GEN3_DOMAIN_NAME}"

          NODE_LIST: "%{GEN4_DOMD_NODE_ID} %{GEN3_DOMD_NODE_ID}"
          UM_LIST: "%{GEN4_DOMD_NODE_ID} %{GEN3_DOMD_NODE_ID}"
          NODE_ADDRESSES: "%{GEN4_DOMD_HOST_NAME}.%{GEN4_DOMAIN_NAME} %{GEN3_DOMD_HOST_NAME}.%{GEN3_DOMAIN_NAME}"

        components:
          gen3-dom0:
            default: true
          gen3-domd-fota:
            default: true

        images:
          gen3_full:
            type: gpt
            desc: "Full SD-card/eMMC image"
            partitions:
              boot_a:
                gpt_type: 21686148-6449-6E6F-744E-656564454649 # BIOS boot partition (kinda...)
                type: ext4
                size: 128 MiB
                files:
                  "/aos/version": "%{YOCTOS_WORK_DIR}/%{GEN3_DOM0_BUILD_DIR}/tmp/deploy/images/%{GENERIC_MACHINE}/aos/version"
                  "Image": "%{YOCTOS_WORK_DIR}/%{GEN3_DOM0_BUILD_DIR}/tmp/deploy/images/%{GENERIC_MACHINE}/Image"
                  "uInitramfs": "%{YOCTOS_WORK_DIR}/%{GEN3_DOM0_BUILD_DIR}/tmp/deploy/images/%{GENERIC_MACHINE}/uInitramfs"
                  "xen": "%{YOCTOS_WORK_DIR}/%{GEN3_DOMD_BUILD_DIR}/tmp/deploy/images/%{GEN3_MACHINE}/xen-%{GEN3_MACHINE}.uImage"
                  "xenpolicy": "%{YOCTOS_WORK_DIR}/%{GEN3_DOMD_BUILD_DIR}/tmp/deploy/images/%{GEN3_MACHINE}/xenpolicy-%{GEN3_MACHINE}"
                  "xen.dtb": "%{YOCTOS_WORK_DIR}/%{GEN3_DOMD_BUILD_DIR}/tmp/deploy/images/%{GEN3_MACHINE}/%{GEN3_XT_XEN_DTB_NAME}"

              boot_b:
                gpt_type: 21686148-6449-6E6F-744E-656564454649 # BIOS boot partition (kinda...)
                type: ext4
                size: 128 MiB
                files:
                  "/aos/version": "%{YOCTOS_WORK_DIR}/%{GEN3_DOM0_BUILD_DIR}/tmp/deploy/images/%{GENERIC_MACHINE}/aos/version"
                  "Image": "%{YOCTOS_WORK_DIR}/%{GEN3_DOM0_BUILD_DIR}/tmp/deploy/images/%{GENERIC_MACHINE}/Image"
                  "uInitramfs": "%{YOCTOS_WORK_DIR}/%{GEN3_DOM0_BUILD_DIR}/tmp/deploy/images/%{GENERIC_MACHINE}/uInitramfs"
                  "xen": "%{YOCTOS_WORK_DIR}/%{GEN3_DOMD_BUILD_DIR}/tmp/deploy/images/%{GEN3_MACHINE}/xen-%{GEN3_MACHINE}.uImage"
                  "xenpolicy": "%{YOCTOS_WORK_DIR}/%{GEN3_DOMD_BUILD_DIR}/tmp/deploy/images/%{GEN3_MACHINE}/xenpolicy-%{GEN3_MACHINE}"
                  "xen.dtb": "%{YOCTOS_WORK_DIR}/%{GEN3_DOMD_BUILD_DIR}/tmp/deploy/images/%{GEN3_MACHINE}/%{GEN3_XT_XEN_DTB_NAME}"

              boot_env:
                gpt_type: 21686148-6449-6E6F-744E-656564454649 # BIOS boot partition (kinda...)
                type: vfat
                size: 16 MiB

              domd_rootfs:
                gpt_type: B921B045-1DF0-41C3-AF44-4C6F280D3FAE # Linux aarch64 root
                type: raw_image
                image_path: "%{YOCTOS_WORK_DIR}/%{GEN3_DOMD_BUILD_DIR}/tmp/deploy/images/%{GEN3_MACHINE}/core-image-weston-%{GEN3_MACHINE}.ext4"
                size: 1024 MiB

              domd_var:
                gpt_type: 0FC63DAF-8483-4772-8E79-3D69D8477DE4 # Linux filesystem data
                type: ext4
                size: 1024 MiB
                files:
                  "/aos/.unprovisioned": "%{YOCTOS_WORK_DIR}/%{GEN3_DOMD_BUILD_DIR}/tmp/deploy/images/%{GEN3_MACHINE}/aos/.unprovisioned"

              domd_aos:
                gpt_type: CA7D7CCB-63ED-4C53-861C-1742536059CC # LUKS partition
                type: empty
                size: 1024 MiB

              dom0_aos:
                gpt_type: B921B045-1DF0-41C3-AF44-4C6F280D3FAE # Linux aarch64 root
                type: ext4
                size: 512 MiB
                files:
                  "/.unprovisioned": "%{YOCTOS_WORK_DIR}/%{GEN3_DOM0_BUILD_DIR}/tmp/deploy/images/%{GENERIC_MACHINE}/aos/.unprovisioned"

    disable:
      default: false

    enable-not-build:
      default: false
      overrides:
        variables:
          #GEN3_DOMD_NODE_ID: "rcar-multinode-zephyr-1.0-gen3-domd"
          #GEN3_DOM0_NODE_ID: "rcar-multinode-zephyr-1.0-gen3-boot"
          GEN3_DOMD_NODE_ID: "gen3-domd"
          GEN3_DOM0_NODE_ID: "gen3-dom0"
          #NODE_LIST: "%{GEN4_DOMD_NODE_ID} %{GEN4_DOM0_NODE_ID} %{GEN3_DOMD_NODE_ID} %{GEN3_DOM0_NODE_ID}"
          NODE_LIST: "%{GEN4_DOMD_NODE_ID} %{GEN3_DOMD_NODE_ID}"
          UM_LIST: "%{GEN4_DOMD_NODE_ID} %{GEN3_DOMD_NODE_ID}"
          #NODE_ADDRESSES: "%{GEN4_DOMD_HOST_NAME}.%{GEN4_DOMAIN_NAME} %{GEN4_DOM0_HOST_NAME}.%{GEN4_DOMAIN_NAME} %{GEN3_DOMD_HOST_NAME}.%{GEN3_DOMAIN_NAME} %{GEN3_DOM0_HOST_NAME}.%{GEN3_DOMAIN_NAME}"
          NODE_ADDRESSES: "%{GEN4_DOMD_HOST_NAME}.%{GEN4_DOMAIN_NAME} %{GEN3_DOMD_HOST_NAME}.%{GEN3_DOMAIN_NAME}"

  GEN3_MACHINE:
    desc: "RCAR Gen3-based machine"
    h3ulcb-4x2g-ab:
      default: true
      overrides:
        variables:
          GEN3_MACHINE: "h3ulcb"
          GEN3_SOC_FAMILY: "r8a7795"
          GEN3_XT_DOMD_CONFIG_NAME: "domd-h3ulcb-4x2g-ab.cfg"
          GEN3_XT_OP_TEE_FLAVOUR: "salvator_h3_4x2g"
          GEN3_XT_DOMD_DTB_NAME: "r8a77951-h3ulcb-4x2g-ab-domd.dtb"
          GEN3_XT_XEN_DTB_NAME: "r8a77951-h3ulcb-4x2g-ab-xen.dtb"

    h3ulcb-4x2g:
      overrides:
        variables:
          GEN3_MACHINE: "h3ulcb"
          GEN3_SOC_FAMILY: "r8a7795"
          GEN3_XT_DOMD_CONFIG_NAME: "domd-h3ulcb-4x2g.cfg"
          GEN3_XT_OP_TEE_FLAVOUR: "salvator_h3_4x2g"
          GEN3_XT_DOMD_DTB_NAME: "r8a77951-h3ulcb-4x2g-domd.dtb"
          GEN3_XT_XEN_DTB_NAME: "r8a77951-h3ulcb-4x2g-xen.dtb"

    h3ulcb-4x2g-kf:
      overrides:
        variables:
          GEN3_MACHINE: "h3ulcb"
          GEN3_SOC_FAMILY: "r8a7795"
          GEN3_XT_DOMD_CONFIG_NAME: "domd-h3ulcb-4x2g-kf.cfg"
          GEN3_XT_OP_TEE_FLAVOUR: "salvator_h3_4x2g"
          GEN3_XT_DOMD_DTB_NAME: "r8a77951-h3ulcb-4x2g-kf-domd.dtb"
          GEN3_XT_XEN_DTB_NAME: "r8a77951-h3ulcb-4x2g-kf-xen.dtb"

        components:
          domd:
            sources:
              - type: git
                url: "https://github.com/CogentEmbedded/meta-rcar.git"
                rev: "v5.1.0"
            builder:
              layers:
                - "../../../meta-rcar/meta-rcar-gen3-adas"
                - "../../../meta-xt-rcar/meta-xt-cogent-fixups"
              conf:
                # Ignore OP-TEE patches as we have own OP-TEE
                - [BBMASK_append, " meta-rcar-gen3-adas/recipes-bsp/optee"]

        images:
          full:
            partitions:
              domd_rootfs:
                # For KF we have additional components so we need more space (min +200 MiB)
                size: 2048 MiB

    m3ulcb:
      overrides:
        variables:
          GEN3_MACHINE: "m3ulcb"
          GEN3_SOC_FAMILY: "r8a7796"
          GEN3_XT_DOMD_CONFIG_NAME: "domd-m3ulcb.cfg"
          GEN3_XT_OP_TEE_FLAVOUR: "salvator_m3"
          GEN3_XT_DOMD_DTB_NAME: "r8a7796-m3ulcb-domd.dtb"
          GEN3_XT_XEN_DTB_NAME: "r8a7796-m3ulcb-xen.dtb"

    salvator-x-m3:
      overrides:
        variables:
          GEN3_MACHINE: "salvator-x"
          GEN3_SOC_FAMILY: "r8a7796"
          GEN3_XT_DOMD_CONFIG_NAME: "domd-salvator-x-m3.cfg"
          GEN3_XT_OP_TEE_FLAVOUR: "salvator_m3"
          GEN3_XT_DOMD_DTB_NAME: "r8a77960-salvator-x-domd.dtb"
          GEN3_XT_XEN_DTB_NAME: "r8a77960-salvator-x-xen.dtb"

    salvator-xs-m3-2x4g:
      # This is not misprint. This machine has 2x4 memory config
      overrides:
        variables:
          GEN3_MACHINE: "salvator-x"
          GEN3_SOC_FAMILY: "r8a7796"
          GEN3_XT_DOMD_CONFIG_NAME: "domd-salvator-xs-m3-2x4g.cfg"
          GEN3_XT_OP_TEE_FLAVOUR: "salvator_m3_2x4g"
          GEN3_XT_DOMD_DTB_NAME: "r8a77961-salvator-xs-2x4g-domd.dtb"
          GEN3_XT_XEN_DTB_NAME: "r8a77961-salvator-xs-2x4g-xen.dtb"

    salvator-xs-h3:
      overrides:
        variables:
          GEN3_MACHINE: "salvator-x"
          GEN3_SOC_FAMILY: "r8a7795"
          GEN3_XT_DOMD_CONFIG_NAME: "domd-salvator-xs-h3.cfg"
          GEN3_XT_OP_TEE_FLAVOUR: "salvator_h3"
          GEN3_XT_DOMD_DTB_NAME: "r8a7795-salvator-xs-domd.dtb"
          GEN3_XT_XEN_DTB_NAME: "r8a7795-salvator-xs-xen.dtb"

    salvator-xs-h3-4x2g:
      overrides:
        variables:
          GEN3_MACHINE: "salvator-x"
          GEN3_SOC_FAMILY: "r8a7795"
          GEN3_XT_DOMD_CONFIG_NAME: "domd-salvator-xs-h3-4x2g.cfg"
          GEN3_XT_OP_TEE_FLAVOUR: "salvator_h3_4x2g"
          GEN3_XT_DOMD_DTB_NAME: "r8a7795-salvator-xs-4x2g-domd.dtb"
          GEN3_XT_XEN_DTB_NAME: "r8a7795-salvator-xs-4x2g-xen.dtb"

    salvator-x-h3-4x2g:
      overrides:
        variables:
          GEN3_MACHINE: "salvator-x"
          GEN3_SOC_FAMILY: "r8a7795"
          GEN3_XT_DOMD_CONFIG_NAME: "domd-salvator-x-h3-4x2g.cfg"
          GEN3_XT_OP_TEE_FLAVOUR: "salvator_h3_4x2g"
          GEN3_XT_DOMD_DTB_NAME: "r8a7795-salvator-x-4x2g-domd.dtb"
          GEN3_XT_XEN_DTB_NAME: "r8a7795-salvator-x-4x2g-xen.dtb"

    salvator-x-h3:
      overrides:
        variables:
          GEN3_MACHINE: "salvator-x"
          GEN3_SOC_FAMILY: "r8a7795"
          GEN3_XT_DOMD_CONFIG_NAME: "domd-salvator-x-h3.cfg"
          GEN3_XT_OP_TEE_FLAVOUR: "salvator_h3"
          GEN3_XT_DOMD_DTB_NAME: "r8a7795-salvator-x-domd.dtb"
          GEN3_XT_XEN_DTB_NAME: "r8a7795-salvator-x-xen.dtb"

  # Aos VIS data provider
  VIS_DATA_PROVIDER:
    desc: "Specifies plugin for VIS automotive data"
    renesassimulator:
      default: true
      overrides:
        variables:
          AOS_VIS_DATA_PROVIDER: "renesassimulatoradapter"

    telemetryemulator:
      overrides:
        variables:
          AOS_VIS_DATA_PROVIDER: "telemetryemulatoradapter"

  GEN4_DEVICE:
    desc: "Add RCAR Gen4-based device as Aos nodes"
    enable:
      default: true
    disable:
      default: false
      overrides:
        components:
          gen4-dom0:
            default: false

  GEN4_MACHINE:
    desc: RCAR Gen4-based machine
    spider:
      default: true
      overrides:
        components:
          gen4-domd:
            sources:
              - type: git
                url: https://github.com/renesas-rcar/meta-renesas.git
                rev: "7c29e7bdae360a86fa77ef561e01cc0c18d2e01f"
                dir: "meta-renesas-gen4"
            builder:
              layers:
                - "../../../../../meta-spider-support/meta-spider-support-domd"
              conf:
                - [EXTRA_IMAGEDEPENDS_append, " s4-boot-script"]
                - [IMAGE_INSTALL_append, " s4-boot-script"]
              target_images:
                - "tmp/deploy/images/%{GEN4_MACHINE}/boot-mmc.uImage"
    s4sk:
      overrides:
        variables:
          GEN4_MACHINE: s4sk
        components:
          gen4-dom0:
            builder:
              layers:
                - "../../../../../meta-s4sk-support/meta-s4sk-support-dom0"
          gen4-domd:
            sources:
              - type: git
                url: https://github.com/renesas-rcar/meta-renesas.git
                rev: "fb473de"
                dir: "meta-renesas-gen4"
            builder:
              layers:
                - "../../../../../meta-s4sk-support/meta-s4sk-support-domd"
                - "../../../../../meta-s4sk-support/meta-s4sk-support-driver-domain"
              conf:
                - [EXTRA_IMAGEDEPENDS_append, " s4-boot-script"]
                #- [IMAGE_INSTALL_append, " s4-boot-script"]
              target_images:
                - "tmp/deploy/images/%{GEN4_MACHINE}/boot-ufs.uImage"

  USING_UFS_AS_STORAGE:
    desc: "Using UFS instead of eMMC/SD card"
    "yes":
      default: true
      overrides:
        variables:
          USE_UFS: "1"
        images:
          gen4_full:
            sector_size: 4096
            partitions:
              domd_var:
                files:
                  "/boot-ufs.uImage": "%{YOCTOS_WORK_DIR}/%{GEN4_DOMD_BUILD_DIR}/tmp/deploy/images/%{GEN4_MACHINE}/boot-ufs.uImage"
    "no":
      desc: "Nothing to do"

  FOR_WESTON:
    desc: "Using graphics env common settings"
    "yes":
      default: yes
      overrides:
        variable:
          XT_USE_DDK1_11: "1"
        components:
          gen3-domd:
            builder:
              layer:
                - "../../../meta-xt-rcar/meta-xt-rcar-gles_common"
                - "../../../meta-xt-rcar/meta-xt-rcar-fixups"
              conf:
                - [DISTRO_FEATURES_NATIVESDK_append, " wayland"]
                - [DISTRO_FEATURES_remove, " ptest x11 vulkan"]
                - [DISTRO_FEATURES_append, " pam"]
                - [XT_USE_DDK1_11, "%{XT_USE_DDK1_11}"]
                - [LICENSE_FLAGS_WHITELIST, "commercial"]
                - [BBMASK_append, "|meta-renesas-gen3/meta-rcar-gen3/recipes-connectivity/linuxptp"]
                - [BBMASK_append, "|meta-xt-rcar-driver-domain/recipes-bsp/"]
                - [BBMASK_append,
                  " ${@bb.utils.contains('XT_USE_DDK1_11', '1', '', 'meta-xt-rcar-fixups/recipes-kernel/kernel-module-gles/kernel-module-gles.bbappend', d)}",
                  ]
                - [BBMASK_append,
                  " ${@bb.utils.contains('XT_USE_DDK1_11', '1', '', 'meta-xt-rcar-fixups/recipes-graphics/gles-module/gles-user-module.bbappend', d)}",
                  ]
                - [BBMASK_append,
                  " ${@bb.utils.contains('XT_USE_DDK1_11', '1', '', 'meta-xt-rcar-fixups/recipes-graphics/packagegroups/packagegroup-graphic-renesas.bbappend', d)}",
                  ]
                - [MACHINE_FEATURES_append, " multimedia"]
                - [PREFERRED_RPROVIDER_libgstallocators-1.0, "gstreamer1.0-plugins-base"]
                - [PREFERRED_RPROVIDER_libgstapp-1.0, "gstreamer1.0-plugins-base"]
                - [XT_MULTIMEDIA_EVA_DIR, "%{XT_MULTIMEDIA_EVA_DIR}"]


  PREBUILT_DDK:
    desc: "Use pre-built GPU drivers"
    "yes":
      desc: "専用のGFX packageをもらわないと動かない。meta-aos-rcar-gen3/v3.0.0とも異なるバージョン"
      overrides:
        variables:
          XT_PREBUILT_GSX_DIR: "${TOPDIR}/../../../../../prebuilt_gsx"

        components:
          gen3-domd:
            builder:
              conf:
                - [XT_PREBUILT_GSX_DIR, "%{XT_PREBUILT_GSX_DIR}"]
                # Enable Gfx Pkgs
                - [MACHINE_FEATURES_append, " gsx"]
                - [
                    BB_MULTI_PROVIDER_ALLOWED_append,
                    " virtual/libgl virtual/egl virtual/libgles1 virtual/libgles2",
                  ]
                # Install some apps to test GPU/Display
                - [IMAGE_INSTALL_append, " glmark2"]
                #- [IMAGE_INSTALL_append, " kmscube"]
                - [BBMASK_append, " mesa-gl"]
                # Preferred providers
                - [PREFERRED_PROVIDER_virtual/libgles1, ""]
                - [PREFERRED_PROVIDER_virtual/libgles2, "gles-user-module"]
                - [PREFERRED_PROVIDER_virtual/libgles3, "gles-user-module"]
                - [PREFERRED_PROVIDER_virtual/egl, "libegl"]
                - [PREFERRED_PROVIDER_virtual/libgl, ""]
                - [PREFERRED_PROVIDER_virtual/mesa, ""]
                - [PREFERRED_PROVIDER_virtual/libgbm, "libgbm"]
                - [PREFERRED_PROVIDER_libgbm-dev, "libgbm"]
                - [BBMASK_append, "|meta-aos-rcar-gen3-domd/recipes-graphics/wayland/weston_%.bbappend"]
                - [IMAGE_INSTALL_append, " wayland wayland-kms"]
                # Maybe required with weston 10?
                # - [IMAGE_INSTALL_append, " wayland-wsegl"]
    "nogfx":
      default: yes
      overrides:
        components:
          gen3-domd:
            builder:
              conf:
                - [BBMASK_append, "|gles-user-module|kernel-module-gles|wayland-kms|libgbm"]
                - [BBMASK_append, "|kernel-module-uvcs-drv|omx-user-module"]
                - [BBMASK_append, "|meta-renesas/meta-rcar-gen3/recipes-multimedia/gstreamer"]

  ENABLE_MM:
    desc: "Enable Multimedia support"
    no:
      default: true
      overrides:
        components:
          gen3-domd:
            builder:
              conf:
                # Mask MMP recipes
                - [BBMASK_append, " kernel-module-uvcs-drv omx-user-module"]

# ===================================================================================================================
  ENABLE_DEMO:
    desc: "build demo envrionment or development environment"
    "no":
      default: true
    "yes":
      overrides:
        components:
          gen3-domd:
            sources:
              - type: git
                url: "https://github.com/yhamamachi/meta-rcar-dev-utils"
                rev: "4b66aab8dfc5606c4070c110905132bf33fa115e"
              - type: git
                url: "https://github.com/OSSystems/meta-browser"
                rev: "b61362a891cda9460820398af29945af1d30baae"
              - type: git
                url: "https://github.com/kraj/meta-clang"
                rev: "f14170378aa11d2098a4e82baf680a2c53363191"
            builder:
              conf:
                - [BBMASK_append, "|meta-whitebox-demo/recipes-demo-gen4-"]
                - [BBMASK_append, "|meta-whitebox-demo/recipes-gen3-proprietary"]
                - [PACKAGECONFIG_pn-systemd_append, " networkd"]
                - [PACKAGECONFIG_pn-systemd_append, " timesyncd"]
                - [PACKAGECONFIG_pn-systemd_append, " resolved"]
                - [IMAGE_INSTALL_append, " cluster-app ttf-dejavu-common ttf-dejavu-sans ttf-dejavu-serif"]
                - [IMAGE_INSTALL_append, " ttf-noto-emoji-color ttf-noto-emoji-regular"]
                - [IMAGE_INSTALL_append, " simple-video-streaming python3-opencv"]
                - [IMAGE_INSTALL_append, " iperf3"]
                - [PACKAGECONFIG_pn-chromium-ozone-wayland, " proprietary-codecs"]
                - [IMAGE_INSTALL_append, " chromium-ozone-wayland"]
                # For development
                - [IMAGE_INSTALL_append, " htop ethtool vim usbutils"]
                - [EXTRA_IMAGE_FEATURES_append, " ssh-server-openssh"]
                - [IMAGE_INSTALL_append, " node-exporter autostart-browser"]
                - [IMAGE_INSTALL_remove, "gtk+3-demo"]
                - [EXTRA_IMAGEDEPENDS:append, " boot-script"]
              layers:
                - "../../../../../meta-whitebox-demo"
                - "../../../meta-rcar-dev-utils/meta-rcar-gen3"
                - "../../../meta-rcar-dev-utils/meta-rcar-common"
                - "../../../meta-clang"
                - "../../../meta-browser/meta-chromium"
                - "../../../meta-openembedded/meta-networking"
        images:
          gen3_full:
            type: gpt
            desc: "Full SD-card/eMMC image"
            partitions:
              domd_rootfs:
                size: 2048 MiB
              boot_a:
                items:
                  "boot.uImage": "%{YOCTOS_WORK_DIR}/%{GEN3_DOMD_BUILD_DIR}/tmp/deploy/images/%{GEN3_MACHINE}/boot2.uImage"
              boot_b:
                items:
                  "boot.uImage": "%{YOCTOS_WORK_DIR}/%{GEN3_DOMD_BUILD_DIR}/tmp/deploy/images/%{GEN3_MACHINE}/boot2.uImage"
              domd_var:
                items:
                  #"/": "%{YOCTOS_WORK_DIR}/%{GEN3_DOMD_BUILD_DIR}/tmp/work/h3ulcb-poky-linux/core-image-weston/1.0-r0/rootfs/var"
                  "autostart-browser.config": "%{YOCTOS_WORK_DIR}/%{GEN3_DOMD_BUILD_DIR}/tmp/work/h3ulcb-poky-linux/core-image-weston/1.0-r0/rootfs/var/autostart-browser.config"
                  "log/xen/boot.uImage": "%{YOCTOS_WORK_DIR}/%{GEN3_DOMD_BUILD_DIR}/tmp/deploy/images/%{GEN3_MACHINE}/boot2.uImage"

  SELECT_CLUSTER_COLOR:
    desc: "select cluster color"
    "blue":
      default: true
      overrides:
        components:
          gen3-domd:
            builder:
              conf:
                - [BG_COLOR_AFTER, "11, 66, 121"]
                - [BASE_COLOR_AFTER, "179,214,255"]
                - [ANIME_COLOR_AFTER, "0,102,255"]
    "purple":
      overrides:
        components:
          gen3-domd:
            builder:
              conf:
                - [BG_COLOR_AFTER, "66, 11, 121"]
                - [BASE_COLOR_AFTER, "214,179,255"]
                - [ANIME_COLOR_AFTER, "102,0,255"]
    "yellow":
      overrides:
        components:
          gen3-domd:
            builder:
              conf:
                - [BG_COLOR_AFTER, "123, 123, 0"]
                - [BASE_COLOR_AFTER, "200,200,100"]
                - [ANIME_COLOR_AFTER, "220,220,0"]

# ===================================================================================================================

  ENABLE_WHITEBOX_SDK:
    desc: "Add Whitebox-sdk features"
    "no":
      desc: "Nothing to do"
    "yes":
      default: true
      overrides:
        variables:
          META_WB_LAYER_PATH: "../../../whitebox-sdk/application_cpu/"
          BUILD_DOMD_SDK: "0"
        components:
          gen4-domd:
            sources:
              - type: git
                url: "https://github.com/renesas-rcar/whitebox-sdk.git"
                rev: "v4.0"
            builder:
              conf:
                - [BUILD_SDK, "%{BUILD_DOMD_SDK}"]
                - [IMAGE_INSTALL_append, " iproute2-tc snort"]
                - [IMAGE_INSTALL_append, " iccom-lib iccom-test"]
                - [IMAGE_INSTALL_append, " docker python3-docker-compose"]
                - [IMAGE_INSTALL_append, " dhrystone whetstone sysbench"]
                - [IMAGE_INSTALL_append, " waii"]
                - [IMAGE_INSTALL_append, " node-exporter"]
                - [EXTRA_IMAGEDEPENDS_append, " s4-boot-script"]
                - [IMAGE_INSTALL_append, " ufs-duplication-script"]
                - [IMAGE_INSTALL_append, " packagegroup-system-monitor"]
              layers:
                - "%{META_WB_LAYER_PATH}/meta-rcar-whitebox/meta-rcar-common"
                - "%{META_WB_LAYER_PATH}/meta-rcar-whitebox/meta-domd"
              target_images:
                - "tmp/deploy/images/%{GEN4_MACHINE}/var/statestorage.db"
        images:
          gen4_full:
            partitions:
              domd_rootfs:
                size: 3072 MiB
              domd_var:
                size: 1024 MiB
                files:
                  "statestorage.db": "%{YOCTOS_WORK_DIR}/%{GEN4_DOMD_BUILD_DIR}/tmp/deploy/images/%{GEN4_MACHINE}/var/statestorage.db"
              domd_aos:
                size: 3072 MiB

  ENABLE_WHITEBOX_SDK_DEMO:
    desc: "Expand whitebox-sdk for demo"
    "no":
      desc: "Nothing to do"
    "yes":
      default: true
      overrides:
        components:
          #          dom0:
          #            builder:
          #              conf:
          #                - [BBMASK_append, "meta-whitebox-demo/recipes-demo-gen3"]
          #                - [BBMASK_append, "|meta-whitebox-demo/recipes-demo-gen4-domd"]
          #                - [BBMASK_append, "|meta-whitebox-demo/recipes-gen3-proprietary"]
          #              layers:
          #                - "../../../../meta-whitebox-demo"
          gen4-domd:
            builder:
              conf:
                # Remove unused recipes
                - [BBMASK_append, "|meta-whitebox-demo/recipes-demo-gen3"]
                - [BBMASK_append, "|meta-whitebox-demo/recipes-demo-gen4-dom0"]
                - [BBMASK_append, "|meta-whitebox-demo/recipes-gen3-proprietary"]
                # Remoce existing network settings
                #- [BBMASK_append, "|meta-aos-rcar-gen4-driver-domain/recipes-connectivity/xen-network"]
                # Add additional applications
                - [IMAGE_INSTALL_append, " python3-pip python3-websockets"]
                - [IMAGE_INSTALL_append, " alcohol-recv-server rh850-ota-master"]
                - [IMAGE_INSTALL_append, " driving-sim-translator dummy-driving-sim"]
                - [IMAGE_INSTALL_append, " monitoring-vissv2server"]
                - [IMAGE_INSTALL_append, " api-server"]
                - [IMAGE_INSTALL_append, " rps-setup"]
                # For development
                - [IMAGE_INSTALL_append, " vim curl htop"]
              layers:
                - "../../../../../meta-whitebox-demo"
        images:
          gen4_full:
            partitions:
              domd_var:
                size: 2048 MiB
                files:
                  "RH850-OTA-MASTER.config": "%{YOCTOS_WORK_DIR}/%{GEN4_DOMD_BUILD_DIR}/tmp/deploy/images/%{GEN4_MACHINE}/var/RH850-OTA-MASTER.config"

